<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Integrating OAuth2.0 with Magistrala - Abstract Machines</title>
  <meta name="title" content="Integrating OAuth2.0 with Magistrala - Abstract Machines" />
  <meta name="description" content="Explore how Magistrala integrates OAuth2.0 to enhance authentication with support for Google and other providers." />

  <link rel="canonical" href="https://absmach.eu/blog/integrating-oauth2/" />

  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="Abstract Machines" />
  <meta property="og:url" content="https://absmach.eu/blog/integrating-oauth2" />
  <meta property="og:title" content="Integrating OAuth2.0 with Magistrala" />
  <meta property="og:description" content="Explore how Magistrala integrates OAuth2.0 to enhance authentication with support for Google and other providers." />
  <meta property="og:image" content="https://absmach.eu{https://absmach.eu/img/logos/social-preview.png}" />

  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Integrating OAuth2.0 with Magistrala" />
  <meta name="twitter:description" content="Explore how Magistrala integrates OAuth2.0 to enhance authentication with support for Google and other providers." />
  <meta name="twitter:image" content="https://absmach.eu{https://absmach.eu/img/logos/social-preview.png}" />


  
  <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": "Integrating OAuth2.0 with Magistrala",
        "image": "https:\/\/absmach.eu",
        "datePublished": "2024-04-29",
        "author": {
          "@type": "Person",
          "name": "Rodney Osodo"
        },
        "description": "Explore how Magistrala integrates OAuth2.0 to enhance authentication with support for Google and other providers."
      }
    </script>

  
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png" />

  
  <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet" />

  
  <link rel="stylesheet" type="text/css" href="/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <link rel="stylesheet" href="/assets/css/blog.css" />

  <style>
    body {
      padding-top: 85px;
    }

    .navbar-nav .nav-link {
      color: black !important;
    }

     
    .markdown-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1.5rem 0;
    }

    .markdown-content h2,
    .markdown-content h3 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-weight: 700;
      color: #212529;
    }

    .markdown-content p {
      margin-bottom: 1.25rem;
      line-height: 1.8;
      font-size: 1.1rem;
      color: #333;
    }

    .markdown-content pre {
      border-radius: 6px;
      padding: 1rem;
    }

    .markdown-content blockquote {
      border-left: 4px solid #ddd;
      padding-left: 1rem;
      color: #555;
      margin: 1.5rem 0;
      font-style: italic;
    }

    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.5rem 0;
    }

    .markdown-content th,
    .markdown-content td {
      border: 1px solid #ddd;
      padding: 0.6rem 0.8rem;
    }

    .markdown-content th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .code-wrapper {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .code-wrapper pre {
      margin-bottom: 0;
    }

    .copy-button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .code-wrapper:hover .copy-button {
      opacity: 1;
    }

    .copy-button:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    .copy-button.copied {
      background: #198754;
      border-color: #198754;
      color: #fff;
      opacity: 1;
    }
  </style>
</head>

<body>
  
  <nav class="navbar navbar-expand-lg fixed-top navbar-light bg-white" style="font-size: 21px">
    <div class="container">
      <a class="navbar-brand" href="/">
        <img src="/img/logos/abstract-machines_logo_landscape-black.jpg" alt="Magistrala" height="30" width="250" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark" href="#" id="productsDropdown" role="button"
              data-bs-toggle="dropdown">
              Products
            </a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Software</li>
              <li>
                <a class="dropdown-item" href="https://magistrala.absmach.eu" target="_blank"
                  rel="noopener noreferrer">Magistrala</a>
              </li>
              <li><a class="dropdown-item" href="/supermq/">SuperMQ</a></li>
              <li>
                <a class="dropdown-item" href="/propeller/">Propeller</a>
              </li>
              <li><a class="dropdown-item" href="/mproxy/">mProxy</a></li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <li class="dropdown-header">Hardware</li>
              <li>
                <a class="dropdown-item" href="/s0/">S0 Low Power Gateway</a>
              </li>
              <li>
                <a class="dropdown-item" href="/s1/">S1 Linux Gateway</a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <li>
                <a class="dropdown-item" href="/products/">All Products</a>
              </li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link text-dark" href="/solutions/">Solutions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/services/">Services</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/projects/">Projects</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/company/">Company</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/careers/">Careers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/contact/">Contact</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/blog/">Blog</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="https://github.com/absmach" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <article class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        
        <div class="mb-4">
          <a href="/blog" class="text-decoration-none text-muted"><i class="fas fa-arrow-left me-2"></i>Back to Blog</a>
        </div>

        <div class="mb-3">
          <span class="badge bg-primary fs-6"></span>
          
        </div>

        <h1 class="display-4 fw-bold mb-4">Integrating OAuth2.0 with Magistrala</h1>

        <div class="d-flex align-items-center mb-4 pb-4 border-bottom">
          <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo" class="rounded-circle me-3" width="60" height="60"
            loading="lazy" onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
          <div>
            <div class="fw-bold fs-5">Rodney Osodo</div>
            <div class="text-muted">
              April 29, 2024 Â· 15 min read
            </div>
          </div>
        </div>

        

        <div class="markdown-content"><h1 id="integrating-oauth20-with-magistrala">Integrating OAuth2.0 with Magistrala</h1>
<p>Over the past months, we have been working on integrating OAuth2.0 with Magistrala. We are happy to announce that we have completed the integration and it is <a href="https://github.com/absmach/magistrala/pull/2103">now available</a>. We believe that this will open up a lot of possibilities for Magistrala and we are very excited about the future of Magistrala. We are planning to add more features to the OAuth2.0 integration in future releases. We are also planning to add support for more OAuth2.0 providers. This will enable users to use their preferred OAuth2.0 provider to authenticate with Magistrala.</p>
<!-- raw HTML omitted -->
<p><a href="https://datatracker.ietf.org/doc/html/rfc6749">OAuth2.0</a> is an authorization framework that facilitates a third-party application to gain restricted access to another HTTP service. This can occur either by mediating an approval process between the resource owner and the HTTP service or by enabling the third-party application to autonomously acquire access. In OAuth2.0, a client requests access to a resource controlled by the resource owner and hosted by the resource server and is issued a different set of credentials than those of the resource owner. Instead of using the resource owner's credentials to access the resource, the client obtains an access token - a string representing the grant issued to the client by the resource owner. The client uses the access token to access the protected resources hosted by the resource server.</p>
<p>In OAuth2.0, there are four roles:</p>
<ul>
<li><strong>Resource Owner</strong>: An entity capable of granting access to a protected resource. When the resource owner is a person, it is referred to as an end-user.</li>
<li><strong>Resource Server</strong>: The server hosting the protected resources, is capable of accepting and responding to protected resource requests using access tokens.</li>
<li><strong>Authorization Server</strong>: The server issues access tokens to the client after successfully authenticating the resource owner and obtaining authorization.</li>
<li><strong>Client</strong>: An application making protected resource requests on behalf of the resource owner and with its authorization. The client is not necessarily part of the resource owner's domain.</li>
</ul>
<p>In the context of Magistrala, the resource owner is the user, the resource server is the Magistrala service, the authorization server is the OAuth2.0 provider, and the client is the UI service. The UI service is the client because it is making protected resource requests on behalf of the user and with the user's authorization.</p>
<p>In OAuth2.0, there are different scopes. A scope is a mechanism in OAuth2.0 to limit an application's access to a user's account. A scope is a string that represents the access level that the application is requesting. The scope is included in the request to the authorization server. The scope is used to specify the access level that the application is requesting. The scope is a required parameter in the request to the authorization server.</p>
<p>With Google as the authorization server, we use <code>userinfo.email</code> and <code>userinfo.profile</code> as the scopes. The <code>userinfo.email</code> scope is used to access the user's email address. The <code>userinfo.profile</code> scope is used to access the user's profile information. The user's email address is used to uniquely identify the user. The user's profile information is used to display the user's name and profile picture in the UI.</p>
<p>The abstract OAuth2.0 flow is as follows:</p>
<ol>
<li>The client requests authorization from the resource owner. The authorization request can be made directly to the resource owner or indirectly via the authorization server.</li>
<li>The client receives an authorization grant, which is a credential representing the resource owner's authorization, expressed using one of four grant types defined in the OAuth2.0 specification or using an extension grant type.</li>
<li>The client requests an access token by authenticating with the authorization server and presenting the authorization grant.</li>
<li>The authorization server authenticates the client and validates the authorization grant, and if valid, issues an access token.</li>
<li>The client requests the protected resource from the resource server and authenticates it by presenting the access token.</li>
<li>The resource server validates the access token, and if valid, serves the request.</li>
<li>The client receives the protected resource.</li>
</ol>
<p>This flow is demonstrated in the following diagram:</p>
<p><img src="/img/blogs/oauth/genericflow.png" alt="Generic OAuth2.0 flow"></p>
<p>Magistrala can now be the resource server and Google as one of the authorization servers. We have implemented the OAuth2.0 <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.1">authorization code flow</a>. The authorization code flow is used to obtain an access and refresh token to authorize API requests. The UI client initiates the flow by redirecting the user to the authorization server(Google). The user authenticates and authorizes the client(Magistrala). The authorization server(Google) redirects the user back to the client(Magistrala users service) with an authorization code. The client(Magistrala users service) exchanges the authorization code for an access token and a refresh token. The access token is used to authenticate API requests(get user details). The refresh token is used to obtain a new access token when the current access token becomes invalid or expires. This flow is demonstrated in the following diagram:</p>
<p><img src="/img/blogs/oauth/codeflow.png" alt="authorization code flow"><br>
<em>The authorization code flow(from <a href="https://medium.com/javarevisited/oauth-2-0-authorization-code-flow-in-spring-boot-d8ff393f316d)">https://medium.com/javarevisited/oauth-2-0-authorization-code-flow-in-spring-boot-d8ff393f316d)</a></em></p>
<p>There are different grant types in OAuth2.0. The grant type is a string representing the authorization grant type that the client is using to request the access token. It is included in the request to the token endpoint. It is used to specify the method of obtaining the access token. It is a required parameter in the request to the token endpoint. The grant types are:</p>
<ul>
<li><strong>Authorization code</strong>: The authorization code grant type is used to obtain both access and refresh tokens and is optimized for confidential clients.</li>
<li><strong>Implicit</strong>: The implicit grant type is used to obtain access tokens and is optimized for public clients known to operate a particular redirection URI. These clients are typically implemented in a browser using a scripting language such as JavaScript.</li>
<li><strong>Resource owner password credentials</strong>: The resource owner password credentials grant type is suitable in cases where the resource owner has a trust relationship with the client, such as the device operating system or a highly privileged application.</li>
<li><strong>Client credentials</strong>: The client credentials grant type is used by clients to obtain an access token outside of the context of a user.</li>
</ul>
<p>This flow conforms to <a href="https://openid.net/connect/">OpenID Connect</a> specification, which is an identity layer on top of the OAuth2.0 protocol. OpenID Connect is a simple identity layer on top of the OAuth2.0 protocol, which allows clients to verify the identity of the end-user based on the authentication performed by an authorization server, as well as to obtain basic profile information about the end-user in an interoperable and REST-like manner. We are planning to add support for OpenID Connect in future releases.</p>
<h2 id="how-to-use-oauth20-with-magistrala">How to use OAuth2.0 with Magistrala</h2>
<p>Currently, we have implemented the OAuth2.0 authorization code flow with Google as the authorization server. We are planning to add support for more OAuth2.0 providers in future releases. To use OAuth2.0 with Magistrala, you need to follow the steps below:</p>
<ol>
<li>
<p>You need to obtain the client ID and client secret from Google. You can obtain the client ID and client secret by creating a new project in the <a href="https://console.cloud.google.com/">Google Cloud Console</a>. You can find the client ID and client secret in the <a href="https://console.developers.google.com/apis/credentials">credentials section</a> of the project.</p>
</li>
<li>
<p>Click on the <code>Create credentials</code> button and select <code>OAuth client ID</code>. When setting up the OAuth client, the application type should be <code>Web application</code>. Under authorized redirect URIs, you need to provide the redirect URI of the Magistrala users service. This should be something like <code>https://&lt;domain&gt;/oauth/callback/google</code>. The <code>&lt;domain&gt;</code> should be replaced with the domain of the Magistrala users service or nginix ingress. For local development, you can use <code>http://localhost/oauth/callback/google</code>.</p>
</li>
<li>
<p>Copy the client ID and client secret and provide them to the Magistrala users service. The values should be something like:</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">### Google OAuth2</span>
</span></span><span style="display:flex;"><span>SMQ_GOOGLE_CLIENT_ID=<span style="color:#0ff;font-weight:bold">&#34;01234567-8abc0defg7hijklmnopqr23456s78tu9.apps.googleusercontent.com&#34;</span>
</span></span><span style="display:flex;"><span>SMQ_GOOGLE_CLIENT_SECRET=<span style="color:#0ff;font-weight:bold">&#34;GOCSPX-_abCDEfG1hIJKl4MnO7pQRSTuvwxyz&#34;</span>
</span></span><span style="display:flex;"><span>SMQ_GOOGLE_REDIRECT_URL=<span style="color:#0ff;font-weight:bold">&#34;http://localhost/oauth/callback/google&#34;</span>
</span></span><span style="display:flex;"><span>SMQ_GOOGLE_STATE=<span style="color:#0ff;font-weight:bold">&#34;7NN28jSDAg4z&#34;</span>
</span></span></code></pre><p>The state is a secret key that is shared between the client and the server. It is used to prevent CSRF attacks. The state should be a random string and should be kept secret. The state is used to verify the integrity of the response from the authorization server.<br>
Internally we prefix the state with <code>signin</code> or <code>signup</code> to differentiate between the sign-in and sign-up flows. This is to identify the flow that the user is in. This is important because the sign-in and sign-up flows are different and we need to handle them differently.</p>
</li>
<li>
<p>You can customize the consent screen by providing the application name and the authorized domains. You can also provide the application logo and the application homepage. You can find the consent screen in the <a href="https://console.cloud.google.com/apis/credentials/consent">OAuth consent screen section</a> of the project.</p>
</li>
</ol>
<p>More information about the OAuth2.0 authorization code flow can be found <a href="https://developers.google.com/identity/openid-connect/openid-connect">here</a>.</p>
<p>Here is an example of the OAuth2.0 authorization code flow with Google as the authorization server:</p>
<!-- raw HTML omitted -->
<h2 id="integration">Integration</h2>
<p>This is split into two parts:</p>
<h3 id="1-magistrala-ui-service">1. Magistrala UI Service</h3>
<p>The UI service is the client in the OAuth2.0 flow. The UI service initiates the flow by redirecting the user to the authorization server(Google).</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">// Name returns the name of the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is used to generate the URL for the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// For example, the URL for Google is /signin/google and /signup/google.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) Name() <span style="color:#fff;font-weight:bold">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;google&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Icon returns the icon of the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is used to display the icon of the provider in the UI.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is when rendering the sign-in and sign-up buttons to the user.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) Icon() <span style="color:#fff;font-weight:bold">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;fa-google&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// IsEnabled returns true if the provider is enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is used to determine if the provider is enabled or not.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is when rendering the sign-in and sign-up buttons to the user and when generating the URL for the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) IsEnabled() <span style="color:#fff;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.oauth2.ClientID != <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> &amp;&amp; cfg.oauth2.ClientSecret != <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The above functions are used to generate the URL for the provider and to display the icon of the provider in the UI. The <code>IsEnabled</code> function is used to determine if the provider is enabled or not. This is used to render the sign-in and sign-up buttons to the user.</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span>{{ range $i, $c := .Providers }} {{ if $c.IsEnabled }}
</span></span><span style="display:flex;"><span>&lt;<span style="font-weight:bold">div</span> <span style="color:#007f7f">class</span>=<span style="color:#0ff;font-weight:bold">&#34;text-center text-light&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="font-weight:bold">p</span>&gt;or sign in with:&lt;/<span style="font-weight:bold">p</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="font-weight:bold">button</span> <span style="color:#007f7f">type</span>=<span style="color:#0ff;font-weight:bold">&#34;button&#34;</span> <span style="color:#007f7f">class</span>=<span style="color:#0ff;font-weight:bold">&#34;btn btn-link btn-floating mx-1&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="font-weight:bold">a</span> <span style="color:#007f7f">href</span>=<span style="color:#0ff;font-weight:bold">&#34;/signin/{{ $c.Name }}&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="font-weight:bold">i</span> <span style="color:#007f7f">class</span>=<span style="color:#0ff;font-weight:bold">&#34;fab {{ $c.Icon }}&#34;</span>&gt;&lt;/<span style="font-weight:bold">i</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="font-weight:bold">a</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="font-weight:bold">button</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="font-weight:bold">div</span>&gt;
</span></span><span style="display:flex;"><span>{{ end }} {{ end }}
</span></span></code></pre><pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">// GenerateSignInURL generates the URL for the sign-in flow.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) GenerateSignInURL() (<span style="color:#fff;font-weight:bold">string</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.generateURL(mgoauth2.SignIn.String())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// GenerateSignUpURL generates the URL for the sign-up flow.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) GenerateSignUpURL() (<span style="color:#fff;font-weight:bold">string</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.generateURL(mgoauth2.SignUp.String())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// generateURL generates the URL for the sign-in and sign-up flows.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) generateURL(state <span style="color:#fff;font-weight:bold">string</span>) (<span style="color:#fff;font-weight:bold">string</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    URL, err := url.Parse(cfg.oauth2.Endpoint.AuthURL)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, fmt.Errorf(<span style="color:#0ff;font-weight:bold">&#34;failed to parse google auth url: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parameters := url.Values{}
</span></span><span style="display:flex;"><span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;client_id&#34;</span>, cfg.oauth2.ClientID)
</span></span><span style="display:flex;"><span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;scope&#34;</span>, strings.Join(cfg.oauth2.Scopes, <span style="color:#0ff;font-weight:bold">&#34; &#34;</span>))
</span></span><span style="display:flex;"><span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;redirect_uri&#34;</span>, cfg.oauth2.RedirectURL)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// response_type=code is required to get the access token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;response_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// access_type=offline is required to get the refresh token for the first time
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;access_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;offline&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// prompt=consent is required to get the refresh token subsequently
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;prompt&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;consent&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// signin or signup is prepended to the state to be used in the callback state is prepended to the state to be used in the callback
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    parameters.Add(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>, fmt.Sprintf(<span style="color:#0ff;font-weight:bold">&#34;%s-%s&#34;</span>, state, cfg.state))
</span></span><span style="display:flex;"><span>    URL.RawQuery = parameters.Encode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> URL.String(), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The above functions are used to generate the URL for the sign-in and sign-up flows. The <code>generateURL</code> function is used to generate the URL for the provider. The URLs are used to redirect the user to the authorization server(Google).</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> _, provider := <span style="color:#fff;font-weight:bold">range</span> providers {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> provider.IsEnabled() {
</span></span><span style="display:flex;"><span>        r.HandleFunc(<span style="color:#0ff;font-weight:bold">&#34;/signup/&#34;</span>+provider.Name(), oauth2Handler(oauth2.SignUp, provider))
</span></span><span style="display:flex;"><span>        r.HandleFunc(<span style="color:#0ff;font-weight:bold">&#34;/signin/&#34;</span>+provider.Name(), oauth2Handler(oauth2.SignIn, provider))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">// oauth2Handler is a http.HandlerFunc that handles OAuth2 callbacks.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// For valid states, the handler generates the URL for the provider and redirects the user to the URL.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// For invalid states, the handler redirects the user to the login page.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> oauth2Handler(state oauth2.State, provider oauth2.Provider) http.HandlerFunc {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> url <span style="color:#fff;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> err <span style="color:#fff;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">switch</span> state {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">case</span> oauth2.SignIn:
</span></span><span style="display:flex;"><span>            url, err = provider.GenerateSignInURL()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">case</span> oauth2.SignUp:
</span></span><span style="display:flex;"><span>            url, err = provider.GenerateSignUpURL()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>            err = fmt.Errorf(<span style="color:#0ff;font-weight:bold">&#34;invalid state&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            http.Redirect(w, r, <span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>, http.StatusTemporaryRedirect)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        http.Redirect(w, r, url, http.StatusTemporaryRedirect)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="2-magistrala-users-service">2. Magistrala Users Service</h3>
<p>The users service is the resource server in the OAuth2.0 flow. The users service receives the authorization code from the authorization server(Google) and exchanges the authorization code for an access and refresh token. The users service then uses the access token to obtain the user's details.</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">// State returns the state of the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is used to verify the integrity of the response from the authorization server.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) State() <span style="color:#fff;font-weight:bold">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.state
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// RedirectURL returns the URL to redirect the user when the OAuth2.0 flow is complete.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) RedirectURL() <span style="color:#fff;font-weight:bold">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.uiRedirectURL
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// ErrorURL returns the URL to redirect the user when an error occurs.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) ErrorURL() <span style="color:#fff;font-weight:bold">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.errorURL
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// IsEnabled returns true if the provider is enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// This is used to determine if the provider is enabled or not when generating the callback URL for the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) IsEnabled() <span style="color:#fff;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> cfg.config.ClientID != <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> &amp;&amp; cfg.config.ClientSecret != <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <code>IsEnabled</code> function is used to determine if the provider is enabled or not. This is used to generate the callback URL for the provider.</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> _, provider := <span style="color:#fff;font-weight:bold">range</span> providers {
</span></span><span style="display:flex;"><span>    r.HandleFunc(<span style="color:#0ff;font-weight:bold">&#34;/oauth/callback/&#34;</span>+provider.Name(), oauth2CallbackHandler(provider, svc))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">// oauth2CallbackHandler is a http.HandlerFunc that handles OAuth2 callbacks.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">func</span> oauth2CallbackHandler(oauth oauth2.Provider, svc users.Service) http.HandlerFunc {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> !oauth.IsEnabled() {
</span></span><span style="display:flex;"><span>            http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=oauth%20provider%20is%20disabled&#34;</span>, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// state is prefixed with signin- or signup- to indicate which flow we should use
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">var</span> state <span style="color:#fff;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> flow oauth2.State
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> err <span style="color:#fff;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> strings.Contains(r.FormValue(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>), <span style="color:#0ff;font-weight:bold">&#34;-&#34;</span>) {
</span></span><span style="display:flex;"><span>            state = strings.Split(r.FormValue(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>), <span style="color:#0ff;font-weight:bold">&#34;-&#34;</span>)[<span style="color:#ff0;font-weight:bold">1</span>]
</span></span><span style="display:flex;"><span>            flow, err = oauth2.ToState(strings.Split(r.FormValue(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>), <span style="color:#0ff;font-weight:bold">&#34;-&#34;</span>)[<span style="color:#ff0;font-weight:bold">0</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=&#34;</span>+err.Error(), http.StatusSeeOther) <span style="color:#007f7f">//nolint:goconst
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> state != oauth.State() {
</span></span><span style="display:flex;"><span>            http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=invalid%20state&#34;</span>, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> code := r.FormValue(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>); code != <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>            token, err := oauth.Exchange(r.Context(), code)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=&#34;</span>+err.Error(), http.StatusSeeOther)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            client, err := oauth.UserInfo(token.AccessToken)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=&#34;</span>+err.Error(), http.StatusSeeOther)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            jwt, err := svc.OAuthCallback(r.Context(), flow, client)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=&#34;</span>+err.Error(), http.StatusSeeOther)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            http.SetCookie(w, &amp;http.Cookie{
</span></span><span style="display:flex;"><span>                Name:     <span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>,
</span></span><span style="display:flex;"><span>                Value:    jwt.AccessToken,
</span></span><span style="display:flex;"><span>                Path:     <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>                HttpOnly: <span style="color:#fff;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>                Secure:   <span style="color:#fff;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            http.SetCookie(w, &amp;http.Cookie{
</span></span><span style="display:flex;"><span>                Name:     <span style="color:#0ff;font-weight:bold">&#34;refresh_token&#34;</span>,
</span></span><span style="display:flex;"><span>                Value:    *jwt.RefreshToken,
</span></span><span style="display:flex;"><span>                Path:     <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>                HttpOnly: <span style="color:#fff;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>                Secure:   <span style="color:#fff;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            http.Redirect(w, r, oauth.RedirectURL(), http.StatusFound)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        http.Redirect(w, r, oauth.ErrorURL()+<span style="color:#0ff;font-weight:bold">&#34;?error=empty%20code&#34;</span>, http.StatusSeeOther)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The oauth2CallbackHandler is a http.HandlerFunc that handles OAuth2 callbacks. The handler verifies the integrity of the response from the authorization server and redirects the user to the URL when the OAuth2.0 flow is complete or when an error occurs. The handler also sets the access and refresh tokens in the user's session.</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (cfg *config) UserInfo(accessToken <span style="color:#fff;font-weight:bold">string</span>) (mfclients.Client, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    resp, err := http.Get(userInfoURL + url.QueryEscape(accessToken))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mfclients.Client{}, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">defer</span> resp.Body.Close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> resp.StatusCode != http.StatusOK {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mfclients.Client{}, svcerr.ErrAuthentication
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data, err := io.ReadAll(resp.Body)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mfclients.Client{}, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> user <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>        ID      <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>        Name    <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>        Email   <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>        Picture <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`json:&#34;picture&#34;`</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := json.Unmarshal(data, &amp;user); err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mfclients.Client{}, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> user.ID == <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> || user.Name == <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> || user.Email == <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mfclients.Client{}, svcerr.ErrAuthentication
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client := mfclients.Client{
</span></span><span style="display:flex;"><span>        ID:   user.ID,
</span></span><span style="display:flex;"><span>        Name: user.Name,
</span></span><span style="display:flex;"><span>        Credentials: mfclients.Credentials{
</span></span><span style="display:flex;"><span>            Identity: user.Email,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        Metadata: <span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{}{
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;oauth_provider&#34;</span>:  providerName,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;profile_picture&#34;</span>: user.Picture,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        Status: mfclients.EnabledStatus,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> client, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <code>UserInfo</code> function is used to obtain the user's details. The function then uses the access token to obtain the user's details. The user's details are used to uniquely identify the user and to display the user's name and profile picture in the UI.</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (svc service) OAuthCallback(ctx context.Context, state mgoauth2.State, client mgclients.Client) (*magistrala.Token, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> state {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> mgoauth2.SignIn:
</span></span><span style="display:flex;"><span>        rclient, err := svc.clients.RetrieveByIdentity(ctx, client.Credentials.Identity)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> errors.Contains(err, repoerr.ErrNotFound) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> &amp;magistrala.Token{}, errors.New(<span style="color:#0ff;font-weight:bold">&#34;user not signed up&#34;</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> &amp;magistrala.Token{}, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        claims := &amp;magistrala.IssueReq{
</span></span><span style="display:flex;"><span>            UserId: rclient.ID,
</span></span><span style="display:flex;"><span>            Type:   <span style="color:#fff;font-weight:bold">uint32</span>(auth.AccessKey),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> svc.auth.Issue(ctx, claims)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> mgoauth2.SignUp:
</span></span><span style="display:flex;"><span>        rclient, err := svc.RegisterClient(ctx, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, client)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> errors.Contains(err, repoerr.ErrConflict) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> &amp;magistrala.Token{}, errors.New(<span style="color:#0ff;font-weight:bold">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> &amp;magistrala.Token{}, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        claims := &amp;magistrala.IssueReq{
</span></span><span style="display:flex;"><span>            UserId: rclient.ID,
</span></span><span style="display:flex;"><span>            Type:   <span style="color:#fff;font-weight:bold">uint32</span>(auth.AccessKey),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> svc.auth.Issue(ctx, claims)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> &amp;magistrala.Token{}, fmt.Errorf(<span style="color:#0ff;font-weight:bold">&#34;unknown state %s&#34;</span>, state)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <code>OAuthCallback</code> function is used to handle the OAuth2.0 callback. The function issues a token to the user and sets the access and refresh tokens in the user's session. Depending on the state, the function either signs in the user or signs up the user.</p>
<p>We don't store the access token or refresh token since they are only used once to obtain the user's details. The access token is used to authenticate the user.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In conclusion, the successful integration of OAuth2.0 with Magistrala represents a significant milestone in enhancing the security and functionality of our platform. By leveraging OAuth2.0, we enable seamless authentication and authorization processes, empowering users to securely access Magistrala services with their preferred OAuth2.0 provider. With OAuth2.0, users can grant access to their protected resources hosted on Magistrala, facilitating secure interactions between third-party applications and Magistrala services. Through the OAuth2.0 authorization code flow, users can obtain access and refresh tokens, ensuring secure and authenticated API requests.</p>
<p>Moving forward, we are dedicated to expanding our OAuth2.0 integration by adding support for additional providers and implementing new features to enrich the user experience. This integration not only enhances the security and usability of Magistrala but also lays the foundation for future innovations and integrations. We are excited about the opportunities that OAuth2.0 integration brings and look forward to the continued evolution of Magistrala.</p>
</div>

        <div class="mt-5 pt-4 border-top">
          
          <div>
            <a href="/blog" class="btn btn-outline-secondary"><i
                class="fas fa-arrow-left me-2"></i>Back to
              Blog</a>
          </div>
          <h5 class="mb-3 mt-3">Tags</h5>
          <div>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">OAuth2.0</span>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">Authentication</span>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">Magistrala</span>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">Google OAuth</span>
            
          </div>
        </div>

        <div class="mt-4">
          <h5 class="mb-3">Share this article</h5>
          <div class="d-flex gap-2 flex-wrap">
            <a href="https://twitter.com/intent/tweet?text=Integrating&#43;OAuth2.0&#43;with&#43;Magistrala&url=https%3a%2f%2fabsmach.eu/blog/integrating-oauth2"
              target="_blank" rel="noopener" class="btn btn-outline-dark btn-sm">
              <i class="fab fa-twitter me-2"></i>Twitter
            </a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fabsmach.eu/blog/integrating-oauth2"
              target="_blank" rel="noopener" class="btn btn-outline-dark btn-sm">
              <i class="fab fa-linkedin me-2"></i>LinkedIn
            </a>
          </div>
        </div>
      </div>
    </div>
  </article>

  
  <section id="newsletter" class="py-5">
    <div class="container">
      <div class="row mt-5 mb-5">
        <div class="col-md-6 offset-md-3 text-center">
          <h2>Subscribe to Our Newsletter</h2>
          <p>Stay updated with the latest news, updates and announcements.</p>

          
          <form
            action="https://absmach.us11.list-manage.com/subscribe/post?u=70b43c7181d005024187bfb31&amp;id=0a319b6b63&amp;f_id=002711e1f0"
            method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate"
            target="_blank">
            <div class="input-group">
              <input type="email" class="form-control" name="EMAIL" id="mce-EMAIL" placeholder="Enter your email"
                aria-label="Email" aria-describedby="subscribe-btn" required="" />
              <div hidden="">
                <input type="hidden" name="tags" value="8115258" />
              </div>
              <button class="btn bg-deep-blue" type="submit" id="subscribe-btn"
                style="background-color: #073763; color: white;">
                Subscribe
              </button>
            </div>
            <div id="mce-responses" class="clear foot">
              <div class="response" id="mce-error-response" style="display: none"></div>
              <div class="response" id="mce-success-response" style="display: none"></div>
            </div>
            <div style="position: absolute; left: -5000px" aria-hidden="true">
              
              <input type="text" name="b_70b43c7181d005024187bfb31_0a319b6b63" tabindex="-1" value="" />
            </div>

            
            <div class="mt-2">
              <div class="mt-2">
                <p class="mb-0" style="font-size: 0.75rem; color: #6c757d; line-height: 1.4">
                  By subscribing, you agree to our
                  <a href="/privacy" target="_blank" class="link-blue-sm">Privacy Policy</a>
                  and
                  <a href="/terms" target="_blank" class="link-blue-sm">Terms of Service</a>. <br />You can unsubscribe
                  at any time.
                </p>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
  

  
  <section class="py-5 bg-light">
    <div class="container">
      <h3 class="mb-4 fw-bold">Next Read</h3>
      <div class="row g-4">
        
        <div class="col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm hover-lift border-0">
            <a href="/blog/rules-engine" class="text-decoration-none text-dark">
              
              <img src="/img/blogs/rules-engine/rules-ui.png" class="card-img-top" alt="Building a Scriptable Rules Engine for Real-Time IoT Message Processing"
                loading="lazy" onerror="this.style.display = 'none'" style="height: 200px; object-fit: cover;" />
              

              <div class="card-body">
                <div class="mb-2">
                  <span class="badge bg-primary me-2">
                    blog
                  </span>
                  
                </div>

                <h2 class="card-title h5 fw-bold">
                  Building a Scriptable Rules Engine for Real-Time IoT Message Processing
                </h2>
                <p class="card-text text-muted small">
                  Learn how we built a dynamic, scriptable Rules Engine that enables real-time IoT message transformation using Lua and Go, complete with scheduling, observability, and a visual UI.
                </p>

                <div class="d-flex align-items-center mt-3">
                  <img src="https://avatars.githubusercontent.com/u/100555904?v=4" alt="Ian Muchiri"
                    class="rounded-circle me-2" width="32" height="32" loading="lazy"
                    onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
                  <div class="small">
                    <div class="fw-semibold">
                      Ian Muchiri
                    </div>
                    <div class="text-muted">
                      February 03, 2025 Â· 8 min
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  
                  <span class="badge bg-light text-dark me-1">IoT</span>
                  
                  <span class="badge bg-light text-dark me-1">IIoT</span>
                  
                  <span class="badge bg-light text-dark me-1">Magistrala</span>
                  
                  <span class="badge bg-light text-dark me-1">Low-code</span>
                  
                  <span class="badge bg-light text-dark me-1">Real-time-processing</span>
                  
                  <span class="badge bg-light text-dark me-1">Rules-engine</span>
                  
                  <span class="badge bg-light text-dark me-1">Dashboards</span>
                  
                  <span class="badge bg-light text-dark me-1">Observability</span>
                  
                  <span class="badge bg-light text-dark me-1">UI</span>
                  
                  <span class="badge bg-light text-dark me-1">User-guide</span>
                  
                  <span class="badge bg-light text-dark me-1">Golang</span>
                  
                  <span class="badge bg-light text-dark me-1">Lua</span>
                  
                  <span class="badge bg-light text-dark me-1">Scheduling</span>
                  
                </div>
              </div>
            </a>
          </article>
        </div>
        
        <div class="col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm hover-lift border-0">
            <a href="/blog/magistrala-user-guide" class="text-decoration-none text-dark">
              

              <div class="card-body">
                <div class="mb-2">
                  <span class="badge bg-primary me-2">
                    blog
                  </span>
                  
                </div>

                <h2 class="card-title h5 fw-bold">
                  Revolutionizing Industrial IoT with an Open Source Platform
                </h2>
                <p class="card-text text-muted small">
                  
                </p>

                <div class="d-flex align-items-center mt-3">
                  <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo"
                    class="rounded-circle me-2" width="32" height="32" loading="lazy"
                    onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
                  <div class="small">
                    <div class="fw-semibold">
                      Rodney Osodo
                    </div>
                    <div class="text-muted">
                      September 24, 2024 Â· 16 min
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  
                  <span class="badge bg-light text-dark me-1">Magistrala</span>
                  
                  <span class="badge bg-light text-dark me-1">IIoT</span>
                  
                  <span class="badge bg-light text-dark me-1">User Guide</span>
                  
                  <span class="badge bg-light text-dark me-1">Industrial Automation</span>
                  
                  <span class="badge bg-light text-dark me-1">Open Source</span>
                  
                </div>
              </div>
            </a>
          </article>
        </div>
        
        <div class="col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm hover-lift border-0">
            <a href="/blog/v0-14-0-release" class="text-decoration-none text-dark">
              

              <div class="card-body">
                <div class="mb-2">
                  <span class="badge bg-success me-2">
                    announcement
                  </span>
                  
                </div>

                <h2 class="card-title h5 fw-bold">
                  What&#39;s New in Magistrala v0.14.0
                </h2>
                <p class="card-text text-muted small">
                  
                </p>

                <div class="d-flex align-items-center mt-3">
                  <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo"
                    class="rounded-circle me-2" width="32" height="32" loading="lazy"
                    onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
                  <div class="small">
                    <div class="fw-semibold">
                      Rodney Osodo
                    </div>
                    <div class="text-muted">
                      April 19, 2024 Â· 8 min
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  
                  <span class="badge bg-light text-dark me-1">release</span>
                  
                  <span class="badge bg-light text-dark me-1">Magistrala</span>
                  
                  <span class="badge bg-light text-dark me-1">update</span>
                  
                </div>
              </div>
            </a>
          </article>
        </div>
        
      </div>
    </div>
  </section>

  
  <footer class="bg-dark text-white py-3">
    <div class="container">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 mt-4 mb-3">
        
        <div class="col mb-4 text-center text-md-start">
          <h5>About Us</h5>
          <p>
            Abstract Machines is an IoT infrastructure and security company
            located in Paris.
          </p>
          <div class="d-flex justify-content-center justify-content-md-start gap-3 mt-4">
            <a href="https://twitter.com/absmach" class="text-white" target="_blank" aria-label="Twitter">
              <i class="fab fa-twitter fa-lg"></i>
            </a>
            <a href="https://www.linkedin.com/company/abstract-machines" class="text-white" target="_blank"
              aria-label="LinkedIn">
              <i class="fab fa-linkedin fa-lg"></i>
            </a>
            <a href="https://github.com/absmach" class="text-white" target="_blank" aria-label="GitHub">
              <i class="fab fa-github fa-lg"></i>
            </a>
            <a href="https://www.youtube.com/@absmach" class="text-white" target="_blank" aria-label="youtube">
              <i class="fab fa-youtube fa-lg"></i>
            </a>
            <a href="https://matrix.to/#/#supermq:matrix.org" class="text-white" target="_blank" aria-label="matrix">
              <i class="fas fa-comments fa-lg"></i>
            </a>
          </div>
        </div>
        
        <div class="col mb-4 text-center text-md-start">
          <h5>Contact Us</h5>
          <p>
            <i class="fas fa-envelope me-2"></i><a class="text-white" href="mailto:info@absmach.eu">info@absmach.eu</a>
          </p>
          <p>
            <img alt="Matrix Logo" class="me-2" height="28" src="/img/logos/matrix-logo-white.svg" width="60" />
            <a class="text-white" href="https://matrix.to/#/#absmach:matrix.org" target="_blank">Chat on Matrix</a>
          </p>
          <p>
            <i class="fas fa-map-marker-alt me-2"></i>141 Quai de Valmy, 75010
            Paris, France
          </p>
        </div>
        
        <div class="col mb-4 text-center text-md-start">
          <h5>Products</h5>
          <ul class="list-unstyled">
            <li>
              <i class="fas fa-network-wired me-2"></i><a class="text-white" href="https://magistrala.absmach.eu"
                target="_blank">Magistrala - IoT Platform</a>
            </li>
            <li>
              <i class="fas fa-bolt me-2"></i><a class="text-white" href="/supermq/">SuperMQ - Messaging Core</a>
            </li>
            <li>
              <i class="fas fa-rocket me-2"></i><a class="text-white" href="/propeller/">Propeller - Wasm
                Orchestrator</a>
            </li>
          </ul>
        </div>
        
        <div class="col mb-4 text-center text-md-start">
          <h5>Legal</h5>
          <ul class="list-unstyled">
            <li>
              <a class="text-white" href="/terms/" target="_blank">Terms of Service</a>
            </li>
            <li>
              <a class="text-white" href="/privacy/" target="_blank">Privacy Policy</a>
            </li>
            <li>
              <a class="text-white" href="/imprint/" target="_blank">Imprint</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    hljs.highlightAll();

    document.addEventListener('DOMContentLoaded', () => {
      const pres = document.querySelectorAll('.markdown-content pre');

      pres.forEach(pre => {
        const wrapper = document.createElement('div');
        wrapper.className = 'code-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        const btn = document.createElement('button');
        btn.className = 'copy-button';
        btn.type = 'button';
        btn.innerHTML = '<i class="far fa-copy"></i>';
        btn.setAttribute('aria-label', 'Copy code to clipboard');
        btn.title = 'Copy code';

        wrapper.appendChild(btn);
      });
    });

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-button');
      if (!btn) return;

      const pre = btn.parentElement.querySelector('pre');
      const code = pre.querySelector('code') || pre;
      const text = code.textContent;

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }

        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.add('copied');
        btn.title = 'Copied!';

        setTimeout(() => {
          btn.innerHTML = '<i class="far fa-copy"></i>';
          btn.classList.remove('copied');
          btn.title = 'Copy code';
        }, 2000);

      } catch (err) {
        console.error('Copy failed', err);
        btn.innerHTML = '<i class="fas fa-times"></i>';
        setTimeout(() => btn.innerHTML = '<i class="far fa-copy"></i>', 2000);
      }
    });
  </script>

</body>

</html>