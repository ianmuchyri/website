<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Extending Magistrala Users Repository - Abstract Machines</title>
  <meta name="title" content="Extending Magistrala Users Repository - Abstract Machines" />
  <meta name="description" content="Learn how Magistrala integrates with Ory Kratos to enhance user management, featuring MFA, password recovery, and admin APIs." />

  <link rel="canonical" href="https://absmach.eu/blog/extending-users-repository/" />

  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="Abstract Machines" />
  <meta property="og:url" content="https://absmach.eu/blog/extending-users-repository" />
  <meta property="og:title" content="Extending Magistrala Users Repository" />
  <meta property="og:description" content="Learn how Magistrala integrates with Ory Kratos to enhance user management, featuring MFA, password recovery, and admin APIs." />
  <meta property="og:image" content="https://absmach.eu{https://absmach.eu/img/logos/social-preview.png}" />

  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Extending Magistrala Users Repository" />
  <meta name="twitter:description" content="Learn how Magistrala integrates with Ory Kratos to enhance user management, featuring MFA, password recovery, and admin APIs." />
  <meta name="twitter:image" content="https://absmach.eu{https://absmach.eu/img/logos/social-preview.png}" />


  
  <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": "Extending Magistrala Users Repository",
        "image": "https:\/\/absmach.eu",
        "datePublished": "2024-04-17",
        "author": {
          "@type": "Person",
          "name": "Rodney Osodo"
        },
        "description": "Learn how Magistrala integrates with Ory Kratos to enhance user management, featuring MFA, password recovery, and admin APIs."
      }
    </script>

  
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png" />

  
  <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet" />

  
  <link rel="stylesheet" type="text/css" href="/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <link rel="stylesheet" href="/assets/css/blog.css" />

  <style>
    body {
      padding-top: 85px;
    }

    .navbar-nav .nav-link {
      color: black !important;
    }

     
    .markdown-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1.5rem 0;
    }

    .markdown-content h2,
    .markdown-content h3 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-weight: 700;
      color: #212529;
    }

    .markdown-content p {
      margin-bottom: 1.25rem;
      line-height: 1.8;
      font-size: 1.1rem;
      color: #333;
    }

    .markdown-content pre {
      border-radius: 6px;
      padding: 1rem;
    }

    .markdown-content blockquote {
      border-left: 4px solid #ddd;
      padding-left: 1rem;
      color: #555;
      margin: 1.5rem 0;
      font-style: italic;
    }

    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.5rem 0;
    }

    .markdown-content th,
    .markdown-content td {
      border: 1px solid #ddd;
      padding: 0.6rem 0.8rem;
    }

    .markdown-content th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .code-wrapper {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .code-wrapper pre {
      margin-bottom: 0;
    }

    .copy-button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .code-wrapper:hover .copy-button {
      opacity: 1;
    }

    .copy-button:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    .copy-button.copied {
      background: #198754;
      border-color: #198754;
      color: #fff;
      opacity: 1;
    }
  </style>
</head>

<body>
  
  <nav class="navbar navbar-expand-lg fixed-top navbar-light bg-white" style="font-size: 21px">
    <div class="container">
      <a class="navbar-brand" href="/">
        <img src="/img/logos/abstract-machines_logo_landscape-black.jpg" alt="Magistrala" height="30" width="250" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-dark" href="#" id="productsDropdown" role="button"
              data-bs-toggle="dropdown">
              Products
            </a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Software</li>
              <li>
                <a class="dropdown-item" href="https://magistrala.absmach.eu" target="_blank"
                  rel="noopener noreferrer">Magistrala</a>
              </li>
              <li><a class="dropdown-item" href="/supermq/">SuperMQ</a></li>
              <li>
                <a class="dropdown-item" href="/propeller/">Propeller</a>
              </li>
              <li><a class="dropdown-item" href="/mproxy/">mProxy</a></li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <li class="dropdown-header">Hardware</li>
              <li>
                <a class="dropdown-item" href="/s0/">S0 Low Power Gateway</a>
              </li>
              <li>
                <a class="dropdown-item" href="/s1/">S1 Linux Gateway</a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <li>
                <a class="dropdown-item" href="/products/">All Products</a>
              </li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link text-dark" href="/solutions/">Solutions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/services/">Services</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/projects/">Projects</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/company/">Company</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/careers/">Careers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/contact/">Contact</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/blog/">Blog</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="https://github.com/absmach" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <article class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        
        <div class="mb-4">
          <a href="/blog" class="text-decoration-none text-muted"><i class="fas fa-arrow-left me-2"></i>Back to Blog</a>
        </div>

        <div class="mb-3">
          <span class="badge bg-primary fs-6"></span>
          
        </div>

        <h1 class="display-4 fw-bold mb-4">Extending Magistrala Users Repository</h1>

        <div class="d-flex align-items-center mb-4 pb-4 border-bottom">
          <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo" class="rounded-circle me-3" width="60" height="60"
            loading="lazy" onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
          <div>
            <div class="fw-bold fs-5">Rodney Osodo</div>
            <div class="text-muted">
              April 17, 2024 · 7 min read
            </div>
          </div>
        </div>

        

        <div class="markdown-content"><h1 id="extending-magistrala-users-repository">Extending Magistrala Users Repository</h1>
<p>For the past few months, we have been working on integrating Magistrala with <a href="https://www.ory.sh/docs/kratos/ory-kratos-intro">Ory Kratos</a> as the user management service. Ory Kratos is a cloud-native identity and user management system, which can be used as the user management service for Magistrala.</p>
<!-- raw HTML omitted -->
<p>Let's delve deeper into the myriad capabilities that Kratos brings to the forefront:</p>
<ul>
<li>self-service user login and registration. This is the ability to register and log in to the system without the need for an administrator.</li>
<li>multi-factor authentication with Time-based One-time Passwords (TOTP).</li>
<li>account verification. This offers the ability to verify a user's email address.</li>
<li>password recovery. This offers the ability to reset a user's password or recover a forgotten password.</li>
<li>profile and account management. This offers the ability to update a user's profile and account information.</li>
<li>admin API for user management.</li>
</ul>
<p>Our architectural journey has been anchored by the adoption of GoKit which made this a seamless process. Fundamentally, we have been using <a href="https://gokit.io">GoKit</a> as the framework for most of our microservices.</p>
<h2 id="gokit">GoKit</h2>
<p>Go kit is a collection of Go packages that help you build robust, reliable, maintainable microservices. Gokit is not an MVC framework but upholds structuring your microservices in a <a href="https://blog.cleancoder.com/uncle-bob/2011/11/22/Clean-Architecture.html">clean architecture</a> or <a href="https://en.wikipedia.org/wiki/Hexagonal_architecture_(software)">hexagonal architecture</a>:</p>
<ul>
<li>transport layer: responsible for encoding and decoding requests and responses.</li>
<li>endpoint layer: responsible for mapping requests to business logic.</li>
<li>service layer: responsible for business logic.</li>
</ul>
<p>we added an extra layer to most of our services called the <code>repository layer</code>. This crucial layer acts as the intermediary responsible for interfacing with the database, thus fostering a clean separation of concerns wherein the repository layer remains blissfully unaware of the intricacies of the transport layer.</p>
<p><img src="/img/blogs/kratos/architecture.png" alt="Users Service Architecture"></p>
<p>With this architecture, we can decouple the services from the database and make it easier to switch between different databases.</p>
<h2 id="repository-layer">Repository Layer</h2>
<p>The repository layer is responsible for communicating with the database. The repository layer is a thin layer that communicates with the database. It is responsible for:</p>
<ul>
<li>persisting the data.</li>
<li>manipulating the data.</li>
<li>retrieving the data.</li>
<li>deleting the data.</li>
</ul>
<p>The repository is modelled using an interface. The interface defines the methods that the repository layer should implement.</p>
<h2 id="repository-interface">Repository Interface</h2>
<p>The repository interface is defined as follows:</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#007f7f">// Repository defines the required dependencies for Client repository.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//go:generate mockery --name Repository --output=./mocks --filename repository.go --quiet --note &#34;Copyright (c) Abstract Machines&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">type</span> Repository <span style="color:#fff;font-weight:bold">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Save persists in the client account. A non-nil error is returned to indicate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// operation failure.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Save(ctx context.Context, client clients.Client) (clients.Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// RetrieveByID retrieves the client by its unique ID.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RetrieveByID(ctx context.Context, id <span style="color:#fff;font-weight:bold">string</span>) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// RetrieveByIdentity retrieves client by its unique credentials
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RetrieveByIdentity(ctx context.Context, identity <span style="color:#fff;font-weight:bold">string</span>) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// RetrieveAll retrieves all clients.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RetrieveAll(ctx context.Context, pm Page) (ClientsPage, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// RetrieveAllBasicInfo lists all clients only with basic information.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RetrieveAllBasicInfo(ctx context.Context, pm Page) (ClientsPage, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// RetrieveAllByIDs retrieves for given client IDs.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RetrieveAllByIDs(ctx context.Context, pm Page) (ClientsPage, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Update updates the client name and metadata.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Update(ctx context.Context, client Client) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// UpdateTags updates the client tags.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    UpdateTags(ctx context.Context, client Client) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// UpdateIdentity updates the identity of a client with the given id.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    UpdateIdentity(ctx context.Context, client Client) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// UpdateSecret updates the secret for a client with the given identity.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    UpdateSecret(ctx context.Context, client Client) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// UpdateRole updates the role for a client with the given id.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    UpdateRole(ctx context.Context, client Client) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ChangeStatus changes client status to enabled or disabled
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ChangeStatus(ctx context.Context, client Client) (Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// UpdateRole updates the role for a client with the given id.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    UpdateRole(ctx context.Context, client clients.Client) (clients.Client, <span style="color:#fff;font-weight:bold">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// CheckSuperAdmin checks if the user with the given ID is a super admin.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    CheckSuperAdmin(ctx context.Context, adminID <span style="color:#fff;font-weight:bold">string</span>) <span style="color:#fff;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The initial implementation of the repository layer is for PostgreSQL but it can be easily extended and changed to other databases. For this case, we decided to change to using Kratos as the user management service.</p>
<h2 id="comparison">Comparison</h2>
<p>When saving a client, the <a href="https://github.com/absmach/magistrala/blob/2be34c42f4e6acbf98ae8bf9171adb15c031c276/users/postgres/clients.go#L49C1-L76C2">postgresql implementation</a> is as follows:</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (repo *repository) Save(ctx context.Context, c mgclients.Client) (mgclients.Client, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    q := <span style="color:#0ff;font-weight:bold">`INSERT INTO clients (id, name, tags, identity, secret, metadata, created_at, status, role)
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        VALUES (:id, :name, :tags, :identity, :secret, :metadata, :created_at, :status, :role)
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">        RETURNING id, name, tags, identity, metadata, status, created_at`</span>
</span></span><span style="display:flex;"><span>    dbc, err := pgclients.ToDBClient(c)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mgclients.Client{}, errors.Wrap(repoerr.ErrCreateEntity, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    row, err := repo.DB.NamedQueryContext(ctx, q, dbc)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mgclients.Client{}, postgres.HandleError(repoerr.ErrCreateEntity, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">defer</span> row.Close()
</span></span><span style="display:flex;"><span>    row.Next()
</span></span><span style="display:flex;"><span>    dbc = pgclients.DBClient{}
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := row.StructScan(&amp;dbc); err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mgclients.Client{}, errors.Wrap(repoerr.ErrFailedOpDB, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client, err := pgclients.ToClient(dbc)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mgclients.Client{}, errors.Wrap(repoerr.ErrFailedOpDB, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> client, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The <a href="https://github.com/rodneyosodo/magistrala/blob/efbdbf4ca71d33d03b9e0861d47bf2bff2309a29/users/kratos/repository.go#L60C1-L96C2">kratos implementation</a> is as follows:</p>
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;"><code><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (repo *repository) Save(ctx context.Context, user mgclients.Client) (mgclients.Client, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    hashedPassword, err := repo.hasher.Hash(user.Credentials.Secret)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mgclients.Client{}, errors.Wrap(repoerr.ErrCreateEntity, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    state := mgclients.ToOryState(user.Status)
</span></span><span style="display:flex;"><span>    identity, resp, err := repo.IdentityAPI.CreateIdentity(ctx).CreateIdentityBody(
</span></span><span style="display:flex;"><span>        ory.CreateIdentityBody{
</span></span><span style="display:flex;"><span>            SchemaId: repo.schemaID,
</span></span><span style="display:flex;"><span>            Traits: <span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{}{
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;email&#34;</span>:      user.Credentials.Identity,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;username&#34;</span>:   user.Name,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;enterprise&#34;</span>: slices.Contains(user.Tags, <span style="color:#0ff;font-weight:bold">&#34;enterprise&#34;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;newsletter&#34;</span>: slices.Contains(user.Tags, <span style="color:#0ff;font-weight:bold">&#34;newsletter&#34;</span>),
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            State:          &amp;state,
</span></span><span style="display:flex;"><span>            MetadataPublic: user.Metadata,
</span></span><span style="display:flex;"><span>            MetadataAdmin: <span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{}{
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;role&#34;</span>:        user.Role,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;permissions&#34;</span>: user.Permissions,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            Credentials: &amp;ory.IdentityWithCredentials{
</span></span><span style="display:flex;"><span>                Password: &amp;ory.IdentityWithCredentialsPassword{
</span></span><span style="display:flex;"><span>                    Config: &amp;ory.IdentityWithCredentialsPasswordConfig{
</span></span><span style="display:flex;"><span>                        HashedPassword: &amp;hashedPassword,
</span></span><span style="display:flex;"><span>                        Password:       &amp;user.Credentials.Secret,
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    ).Execute()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mgclients.Client{}, errors.Wrap(repoerr.ErrCreateEntity, decodeError(resp))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> toClient(identity), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The PostgreSQL implementation directly inserts client data into the database using a prepared SQL statement. It utilizes a custom type conversion to convert the client object into a format compatible with the database before insertion.</p>
<p>On the other hand, the Kratos implementation interacts with the Kratos Identity service API to create client identities. It hashes the password before sending it to the API and constructs the identity creation request with various client attributes.</p>
<p>From a high-level perspective, both implementations achieve the same goal of saving client data, but they differ in their approach. This is the reason behind using interfaces. Interfaces are important in software design because they:</p>
<ul>
<li>Encapsulate abstraction. An interface defines the behavior of an object, but not its implementation. This allows the implementation to be changed without affecting the clients of the interface.</li>
<li>Promote loose coupling. Loose coupling is a design principle that minimizes the dependencies between modules. This makes the code more flexible and easier to maintain.</li>
<li>Allow polymorphism. Polymorphism is the ability to treat objects of different types similarly. This is made possible by interfaces, which define a common set of methods for different types of objects.</li>
</ul>
<p>With the same service layer with minimal change in logic, the functionality remains the same.</p>
<h2 id="some-pitfalls">Some pitfalls</h2>
<ol>
<li>Creating users. Initially, we hashed passwords in the service layer. However, this was not a good idea because it was not possible to change the hashing algorithm without changing the service layer. We moved the hashing logic to the repository layer.</li>
<li>Client Filtering Optimization: In our quest for efficient client filtering, we initially employed a straightforward SQL query. However, upon integrating with Kratos, we encountered a roadblock – the inability to directly filter users. Consequently, we were compelled to retrieve the user data first and subsequently apply filtering criteria. This iterative process extends to pagination as well, adding a layer of complexity. While this approach may introduce a slight overhead, it ensures compatibility with Kratos and enables us to effectively filter clients despite the inherent limitations.</li>
<li>Our experience with PostgreSQL afforded us the luxury of updating clients with a single, succinct query. However, transitioning to Kratos presented a unique challenge. Due to Kratos' utilization of email as the unique identifier for users, updating clients necessitates a different approach. Rather than directly executing an update query, we first retrieve the user data to obtain the email and username, followed by the execution of the update operation. While this two-step process may seem cumbersome compared to the simplicity of PostgreSQL, it ensures compliance with Kratos' user identification methodology. Despite the additional network calls involved, this approach ensures data integrity and compatibility with Kratos' unique architecture.</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>As we explored the rich capabilities that Kratos brings to the forefront, including self-service user operations, multi-factor authentication, and comprehensive admin APIs, we also encountered several challenges and pitfalls along the way.</p>
<p>In essence, our integration with Ory Kratos exemplifies our commitment to adaptability, flexibility, and resilience. By embracing challenges as opportunities for growth and refinement, we pave the way for a robust and scalable user management solution that meets the evolving needs of Magistrala and its users.</p>
</div>

        <div class="mt-5 pt-4 border-top">
          
          <div>
            <a href="/blog" class="btn btn-outline-secondary"><i
                class="fas fa-arrow-left me-2"></i>Back to
              Blog</a>
          </div>
          <h5 class="mb-3 mt-3">Tags</h5>
          <div>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">Magistrala</span>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">Kratos</span>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">User Management</span>
            
            <span class="badge bg-light text-dark me-2 mb-2 fs-6">Identity</span>
            
          </div>
        </div>

        <div class="mt-4">
          <h5 class="mb-3">Share this article</h5>
          <div class="d-flex gap-2 flex-wrap">
            <a href="https://twitter.com/intent/tweet?text=Extending&#43;Magistrala&#43;Users&#43;Repository&url=https%3a%2f%2fabsmach.eu/blog/extending-users-repository"
              target="_blank" rel="noopener" class="btn btn-outline-dark btn-sm">
              <i class="fab fa-twitter me-2"></i>Twitter
            </a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fabsmach.eu/blog/extending-users-repository"
              target="_blank" rel="noopener" class="btn btn-outline-dark btn-sm">
              <i class="fab fa-linkedin me-2"></i>LinkedIn
            </a>
          </div>
        </div>
      </div>
    </div>
  </article>

  
  <section id="newsletter" class="py-5">
    <div class="container">
      <div class="row mt-5 mb-5">
        <div class="col-md-6 offset-md-3 text-center">
          <h2>Subscribe to Our Newsletter</h2>
          <p>Stay updated with the latest news, updates and announcements.</p>

          
          <form
            action="https://absmach.us11.list-manage.com/subscribe/post?u=70b43c7181d005024187bfb31&amp;id=0a319b6b63&amp;f_id=002711e1f0"
            method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate"
            target="_blank">
            <div class="input-group">
              <input type="email" class="form-control" name="EMAIL" id="mce-EMAIL" placeholder="Enter your email"
                aria-label="Email" aria-describedby="subscribe-btn" required="" />
              <div hidden="">
                <input type="hidden" name="tags" value="8115258" />
              </div>
              <button class="btn bg-deep-blue" type="submit" id="subscribe-btn"
                style="background-color: #073763; color: white;">
                Subscribe
              </button>
            </div>
            <div id="mce-responses" class="clear foot">
              <div class="response" id="mce-error-response" style="display: none"></div>
              <div class="response" id="mce-success-response" style="display: none"></div>
            </div>
            <div style="position: absolute; left: -5000px" aria-hidden="true">
              
              <input type="text" name="b_70b43c7181d005024187bfb31_0a319b6b63" tabindex="-1" value="" />
            </div>

            
            <div class="mt-2">
              <div class="mt-2">
                <p class="mb-0" style="font-size: 0.75rem; color: #6c757d; line-height: 1.4">
                  By subscribing, you agree to our
                  <a href="/privacy" target="_blank" class="link-blue-sm">Privacy Policy</a>
                  and
                  <a href="/terms" target="_blank" class="link-blue-sm">Terms of Service</a>. <br />You can unsubscribe
                  at any time.
                </p>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
  

  
  <section class="py-5 bg-light">
    <div class="container">
      <h3 class="mb-4 fw-bold">Next Read</h3>
      <div class="row g-4">
        
        <div class="col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm hover-lift border-0">
            <a href="/blog/magistrala-user-guide" class="text-decoration-none text-dark">
              

              <div class="card-body">
                <div class="mb-2">
                  <span class="badge bg-primary me-2">
                    blog
                  </span>
                  
                </div>

                <h2 class="card-title h5 fw-bold">
                  Revolutionizing Industrial IoT with an Open Source Platform
                </h2>
                <p class="card-text text-muted small">
                  
                </p>

                <div class="d-flex align-items-center mt-3">
                  <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo"
                    class="rounded-circle me-2" width="32" height="32" loading="lazy"
                    onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
                  <div class="small">
                    <div class="fw-semibold">
                      Rodney Osodo
                    </div>
                    <div class="text-muted">
                      September 24, 2024 · 16 min
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  
                  <span class="badge bg-light text-dark me-1">Magistrala</span>
                  
                  <span class="badge bg-light text-dark me-1">IIoT</span>
                  
                  <span class="badge bg-light text-dark me-1">User Guide</span>
                  
                  <span class="badge bg-light text-dark me-1">Industrial Automation</span>
                  
                  <span class="badge bg-light text-dark me-1">Open Source</span>
                  
                </div>
              </div>
            </a>
          </article>
        </div>
        
        <div class="col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm hover-lift border-0">
            <a href="/blog/integrating-oauth2" class="text-decoration-none text-dark">
              

              <div class="card-body">
                <div class="mb-2">
                  <span class="badge bg-primary me-2">
                    blog
                  </span>
                  
                </div>

                <h2 class="card-title h5 fw-bold">
                  Integrating OAuth2.0 with Magistrala
                </h2>
                <p class="card-text text-muted small">
                  
                </p>

                <div class="d-flex align-items-center mt-3">
                  <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo"
                    class="rounded-circle me-2" width="32" height="32" loading="lazy"
                    onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
                  <div class="small">
                    <div class="fw-semibold">
                      Rodney Osodo
                    </div>
                    <div class="text-muted">
                      April 29, 2024 · 15 min
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  
                  <span class="badge bg-light text-dark me-1">OAuth2.0</span>
                  
                  <span class="badge bg-light text-dark me-1">Authentication</span>
                  
                  <span class="badge bg-light text-dark me-1">Magistrala</span>
                  
                  <span class="badge bg-light text-dark me-1">Google OAuth</span>
                  
                </div>
              </div>
            </a>
          </article>
        </div>
        
        <div class="col-md-6 col-lg-4">
          <article class="card h-100 shadow-sm hover-lift border-0">
            <a href="/blog/v0-14-0-release" class="text-decoration-none text-dark">
              

              <div class="card-body">
                <div class="mb-2">
                  <span class="badge bg-success me-2">
                    announcement
                  </span>
                  
                </div>

                <h2 class="card-title h5 fw-bold">
                  What&#39;s New in Magistrala v0.14.0
                </h2>
                <p class="card-text text-muted small">
                  
                </p>

                <div class="d-flex align-items-center mt-3">
                  <img src="https://avatars.githubusercontent.com/u/28790446?v=4" alt="Rodney Osodo"
                    class="rounded-circle me-2" width="32" height="32" loading="lazy"
                    onerror="this.onerror=null; this.src = '/assets/team/default-avatar.jpg'" />
                  <div class="small">
                    <div class="fw-semibold">
                      Rodney Osodo
                    </div>
                    <div class="text-muted">
                      April 19, 2024 · 8 min
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  
                  <span class="badge bg-light text-dark me-1">release</span>
                  
                  <span class="badge bg-light text-dark me-1">Magistrala</span>
                  
                  <span class="badge bg-light text-dark me-1">update</span>
                  
                </div>
              </div>
            </a>
          </article>
        </div>
        
      </div>
    </div>
  </section>

  
  <footer class="bg-dark text-white py-3">
    <div class="container">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 mt-4 mb-3">
        
        <div class="col mb-4 text-center text-md-start">
          <h5>About Us</h5>
          <p>
            Abstract Machines is an IoT infrastructure and security company
            located in Paris.
          </p>
          <div class="d-flex justify-content-center justify-content-md-start gap-3 mt-4">
            <a href="https://twitter.com/absmach" class="text-white" target="_blank" aria-label="Twitter">
              <i class="fab fa-twitter fa-lg"></i>
            </a>
            <a href="https://www.linkedin.com/company/abstract-machines" class="text-white" target="_blank"
              aria-label="LinkedIn">
              <i class="fab fa-linkedin fa-lg"></i>
            </a>
            <a href="https://github.com/absmach" class="text-white" target="_blank" aria-label="GitHub">
              <i class="fab fa-github fa-lg"></i>
            </a>
            <a href="https://www.youtube.com/@absmach" class="text-white" target="_blank" aria-label="youtube">
              <i class="fab fa-youtube fa-lg"></i>
            </a>
            <a href="https://matrix.to/#/#supermq:matrix.org" class="text-white" target="_blank" aria-label="matrix">
              <i class="fas fa-comments fa-lg"></i>
            </a>
          </div>
        </div>
        
        <div class="col mb-4 text-center text-md-start">
          <h5>Contact Us</h5>
          <p>
            <i class="fas fa-envelope me-2"></i><a class="text-white" href="mailto:info@absmach.eu">info@absmach.eu</a>
          </p>
          <p>
            <img alt="Matrix Logo" class="me-2" height="28" src="/img/logos/matrix-logo-white.svg" width="60" />
            <a class="text-white" href="https://matrix.to/#/#absmach:matrix.org" target="_blank">Chat on Matrix</a>
          </p>
          <p>
            <i class="fas fa-map-marker-alt me-2"></i>141 Quai de Valmy, 75010
            Paris, France
          </p>
        </div>
        
        <div class="col mb-4 text-center text-md-start">
          <h5>Products</h5>
          <ul class="list-unstyled">
            <li class="my-3">
              <i class="fas fa-cogs me-2"></i><a class="text-white" href="https://magistrala.absmach.eu"
                target="_blank">Magistrala - IoT Platform</a>
            </li>
            <li class="my-3">
              <i class="fas fa-comments me-2"></i><a class="text-white" href="/supermq/">SuperMQ - Messaging Core</a>
            </li>
            <li class="my-3">
              <i class="fas fa-network-wired me-2"></i><a class="text-white" href="/propeller/">Propeller - Wasm
                Orchestrator</a>
            </li>
            <li class="my-3">
              <i class="fas fa-shield-alt me-2"></i><a class="text-white" href="/mproxy/"> mProxy - IoT Gateway</a>
            </li>
          </ul>
        </div>
        
        <div class="col mb-4 text-center text-md-start">
          <h5>Legal</h5>
          <ul class="list-unstyled">
            <li class="my-3">
              <a class="text-white" href="/terms/" target="_blank">Terms of Service</a>
            </li>
            <li class="my-3">
              <a class="text-white" href="/privacy/" target="_blank">Privacy Policy</a>
            </li>
            <li class="my-3">
              <a class="text-white" href="/imprint/" target="_blank">Imprint</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    hljs.highlightAll();

    document.addEventListener('DOMContentLoaded', () => {
      const pres = document.querySelectorAll('.markdown-content pre');

      pres.forEach(pre => {
        const wrapper = document.createElement('div');
        wrapper.className = 'code-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        const btn = document.createElement('button');
        btn.className = 'copy-button';
        btn.type = 'button';
        btn.innerHTML = '<i class="far fa-copy"></i>';
        btn.setAttribute('aria-label', 'Copy code to clipboard');
        btn.title = 'Copy code';

        wrapper.appendChild(btn);
      });
    });

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-button');
      if (!btn) return;

      const pre = btn.parentElement.querySelector('pre');
      const code = pre.querySelector('code') || pre;
      const text = code.textContent;

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }

        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.add('copied');
        btn.title = 'Copied!';

        setTimeout(() => {
          btn.innerHTML = '<i class="far fa-copy"></i>';
          btn.classList.remove('copied');
          btn.title = 'Copy code';
        }, 2000);

      } catch (err) {
        console.error('Copy failed', err);
        btn.innerHTML = '<i class="fas fa-times"></i>';
        setTimeout(() => btn.innerHTML = '<i class="far fa-copy"></i>', 2000);
      }
    });
  </script>

</body>

</html>